name: CI Build

on: [ push ]

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

env:
    TZ: UTC

permissions:
    contents: write
    pull-requests: write

jobs:
    compile:
        name: ğŸ’» Compile
        runs-on: ubuntu-latest

        steps:
            -   name: ğŸ”„ Checkout
                uses: actions/checkout@v4

            -   name: âš™ï¸ Common Steps for all jobs
                uses: ./.github/actions/common-steps

            -   name: ğŸ’» Compile
                run: ./gradlew clean classes testClasses testIntegrationClasses

    tests:
        name: Tests
        needs: compile
        runs-on: ubuntu-latest

        steps:
            -   name: ğŸ”„ Checkout
                uses: actions/checkout@v4
            -   name: âš™ï¸ Common Steps for all jobs
                uses: ./.github/actions/common-steps
            -   name: ğŸ§ª Run tests
                run: ./gradlew clean check sonar aggregateReports --scan
                env:
                    SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
                    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            -   name: ğŸŸ¡ Add build scan URL as PR comment
                uses: actions/github-script@v6
                if: github.event_name == 'pull_request' && failure()
                with:
                    github-token: ${{secrets.GITHUB_TOKEN}}
                    script: |
                        github.rest.issues.createComment({
                          issue_number: context.issue.number,
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          body: 'âŒ ${{ github.workflow }} failed: ${{ steps.gradle.outputs.build-scan-url }}'
                        })
            -   name: ğŸ’« Generate JaCoCo Badge
                uses: cicirello/jacoco-badge-generator@v2
                with:
                    generate-branches-badge: true
                    jacoco-csv-file: build/reports/jacoco/aggregateJacocoTestReport/aggregateJacocoTestReport.csv

            -   name: ğŸ“„ Log coverage percentage
                run: |
                    echo "coverage = ${{ steps.jacoco.outputs.coverage }}"
                    echo "branch coverage = ${{ steps.jacoco.outputs.branches }}"

            -   name: â‡ï¸Commit and push the badge (if it changed)
                if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
                uses: EndBug/add-and-commit@v9
                with:
                    default_author: github_actions
                    message: 'commit badge ğŸ€ ${{ steps.jacoco.outputs.coverage }} %'
                    github_token: ${{ secrets.GITHUB_TOKEN }}
            -   name: ğŸ“‘ Upload documentation results
                uses: actions/upload-artifact@v3
                with:
                    name: documentation
                    path: build/documentation

    security:
        name: ğŸ”’Security Checks
        runs-on: ubuntu-latest

        steps:
            -   name: ğŸ”„ Checkout
                uses: actions/checkout@v4
                with:
                    fetch-depth: 0

            -   name: âš™ï¸ Common Steps for all jobs
                uses: ./.github/actions/common-steps

            -   name: ğŸ›¡ï¸Check OWASP
                run: ./gradlew clean dependencyCheckAnalyze
            -   name: ï¸ğŸ›¡ï¸â¬†ï¸ Upload owasp-report results
                uses: actions/upload-artifact@v3
                with:
                    name: owasp-reports
                    path: build/reports/owasp
            -   name: ğŸ—ï¸ ğŸ“¦ Build package
                run: ./gradlew clean assemble dockerCreateDockerfile -x test -x integrationTest
            -   name: ğŸ—ï¸ ğŸ³ Build Container Image
                uses: docker/build-push-action@v5
                with:
                    context: ./apps/app/build/docker/
                    file: ./apps/app/build/docker/Dockerfile
                    push: false
                    tags: n4t5u/yacosta738/kmp-template:latest
            -   name: ğŸ” ğŸªª Scan container using trivy
                id: scan
                uses: azure/container-scan@v0
                with:
                    image-name: n4t5u/yacosta738/kmp-template:latest

    release:
        name: ğŸš€ Release
        needs: [ tests, security ]
        if: github.ref == 'refs/heads/main'
        runs-on: ubuntu-latest

        steps:
            -   name: ğŸ”„ Checkout
                uses: actions/checkout@v4
                with:
                    fetch-depth: 0

            -   name: âš™ï¸ Common Steps for all jobs
                uses: ./.github/actions/common-steps

            -   name: ğŸ—ï¸ ğŸ“¦ Build package
                run: ./gradlew assemble --scan -x test -x integrationTest
            -   name: ğŸŸ¢ Setup Node.js
                uses: actions/setup-node@v3
                with:
                    node-version: 'lts/*'
                    cache: 'npm'
            -   name: ğŸ§© Add plugin for conventional commits
                run: npm install conventional-changelog-conventionalcommits @semantic-release/exec
                working-directory: ./.github/workflows
            -   name: ğŸš€ ğŸŸ£ Release to GitHub
                working-directory: ./.github/workflows
                run: npx semantic-release
                env:
                    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        outputs:
            revnumber: ${{ env.revnumber }}

    build-publish-docker:
        name: ğŸš¢ ğŸ³ Build and Publish Docker Image
        needs: release
        runs-on: ubuntu-latest

        steps:
            -   name: ğŸ”„ Checkout
                uses: actions/checkout@v4

            -   name: âš™ï¸ Common Steps for all jobs
                uses: ./.github/actions/common-steps

            -   name: ğŸ—ï¸ ğŸ“¦ Build package
                run: ./gradlew clean assemble dockerCreateDockerfile -x test -x integrationTest

            -   name: ğŸ¯ Set up QEMU
                uses: docker/setup-qemu-action@v3
            -   name: ğŸ¯ Set up Docker Buildx
                uses: docker/setup-buildx-action@v3
            -   name: Login to Docker Hub
                uses: docker/login-action@v3
                with:
                    username: ${{ secrets.DOCKERHUB_USERNAME }}
                    password: ${{ secrets.DOCKERHUB_TOKEN }}
            -   name: ğŸ—ï¸ Build and push
                uses: docker/build-push-action@v5
                with:
                    context: ./apps/app/build/docker/
                    file: ./apps/app/build/docker/Dockerfile
                    push: true
                    tags: |
                        n4t5u/kmp-template:latest
                        n4t5u/kmp-template:${{ needs.release.outputs.revnumber }}

    publish-docs:
        name: ğŸ”µ ğŸ“„ Publish Docs
        needs: release
        runs-on: ubuntu-latest

        steps:
            -   name: ğŸ”„ Checkout
                uses: actions/checkout@v4
                with:
                    fetch-depth: 0
            -   name: âš™ï¸ Common Steps for all jobs
                uses: ./.github/actions/common-steps
            -   name: â¬‡ï¸ ğŸ“œ Download documentation reports
                uses: actions/download-artifact@v3
                with:
                    name: documentation
                    path: build/documentation
            -   name: â¬‡ï¸ ğŸ›¡ï¸ Download owasp reports
                uses: actions/download-artifact@v3
                with:
                    name: owasp-reports
                    path: build/reports/owasp
            -   name: ğŸ“š Aggregate Documentation
                run: ./gradlew aggregateDocumentation
                env:
                    revnumber: ${{ needs.release.outputs.revnumber }}
            -   name: ğŸŸ¢ ğŸ“š Publish documentation
                uses: JamesIves/github-pages-deploy-action@v4.4.3
                with:
                    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                    BRANCH: gh-pages
                    FOLDER: build/documentation
                    CLEAN: true
